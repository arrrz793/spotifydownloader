<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Downloader Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        }
        
        body { 
            background-color: #0d0d0d; 
            color: white; 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            position: relative; 
            overflow: hidden; 
        }
        
        .bg-grid { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: -1; 
            background-image: 
                linear-gradient(to right, rgba(255, 255, 255, 0.15) 1px, transparent 1px), 
                linear-gradient(to bottom, rgba(255, 255, 255, 0.15) 1px, transparent 1px); 
            background-size: 40px 40px; 
            opacity: 0; 
            animation: fadeInGrid 2s ease-out forwards; 
        }
        
        .bg-grid::after { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: radial-gradient(circle at center, transparent 10%, #0d0d0d 100%); 
        }
        
        .card { 
            width: 100%; 
            max-width: 440px; 
            background: rgba(20, 20, 20, 0.6); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 32px; 
            padding: 60px 40px; 
            text-align: center; 
            box-shadow: 0 40px 100px rgba(0,0,0,0.7); 
            opacity: 0; 
            transform: translateY(40px); 
            animation: cardEntrance 1s cubic-bezier(0.22, 1, 0.36, 1) forwards; 
            animation-delay: 0.3s; 
        }
        
        .spotify-svg { 
            width: 90px; 
            height: 90px; 
            fill: white; 
            margin-bottom: 30px; 
            animation: floatIcon 4s ease-in-out infinite; 
            filter: drop-shadow(0 0 15px rgba(29, 185, 84, 0.4)); 
        }
        
        h1 { 
            font-size: 2.4rem; 
            font-weight: 900; 
            letter-spacing: -1.5px; 
            margin-bottom: 12px; 
        }
        
        h1 span { 
            color: #1DB954; 
        }
        
        .subtitle { 
            color: #8e8e93; 
            font-size: 1rem; 
            margin-bottom: 45px; 
            font-weight: 400; 
        }
        
        .input-group { 
            position: relative; 
            margin-bottom: 25px; 
        }
        
        .input-group i { 
            position: absolute; 
            left: 22px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #636366; 
            transition: color 0.3s ease; 
            font-size: 1.1rem; 
        }
        
        input { 
            width: 100%; 
            padding: 20px 20px 20px 60px; 
            background: rgba(44, 44, 46, 0.4); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            border-radius: 18px; 
            color: white; 
            font-size: 1rem; 
            outline: none; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        input:focus { 
            background: rgba(58, 58, 60, 0.6); 
            border-color: #1DB954; 
            box-shadow: 0 0 25px rgba(29, 185, 84, 0.2); 
        }
        
        input:focus + i { 
            color: #1DB954; 
        }
        
        .btn-dl { 
            width: 100%; 
            padding: 20px; 
            background-color: #1DB954; 
            color: black; 
            font-weight: 800; 
            font-size: 1.1rem; 
            border: none; 
            border-radius: 18px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 12px; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: 0 12px 24px rgba(29, 185, 84, 0.25); 
            margin-top: 10px;
        }
        
        .btn-dl:hover { 
            background-color: #1ed760; 
            transform: translateY(-4px); 
            box-shadow: 0 20px 40px rgba(29, 185, 84, 0.4); 
        }
        
        .btn-dl:active { 
            transform: translateY(-1px); 
        }
        
        .status { 
            margin-top: 35px; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            gap: 14px; 
            color: #1DB954; 
            font-weight: 700; 
            animation: fadeIn 0.5s ease; 
        }
        
        .spin { 
            animation: rotate 1.2s linear infinite; 
            font-size: 22px; 
        }
        
        @keyframes floatIcon { 
            0%, 100% { transform: translateY(0) scale(1); } 
            50% { transform: translateY(-20px) scale(1.08); } 
        }
        
        @keyframes cardEntrance { 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        @keyframes fadeInGrid { 
            to { opacity: 1; } 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        @keyframes rotate { 
            to { transform: rotate(360deg); } 
        }
        
        .shake { 
            animation: shake 0.4s ease-in-out; 
        }
        
        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-8px); } 
            75% { transform: translateX(8px); } 
        }

        #result-area {
            display: none;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.5s ease;
            margin-bottom: 20px;
        }
        
        .album-cover {
            width: 150px;
            height: 150px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1);
        }
        
        .track-info {
            margin-bottom: 20px;
        }
        
        .track-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: white;
        }
        
        .track-artist {
            font-size: 0.9rem;
            color: #b3b3b3;
        }
        
        .meta-badge {
            display: inline-block;
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #1DB954;
            margin-top: 8px;
            margin-right: 6px;
        }
        
        .file-size-badge {
            display: inline-block;
            background: rgba(29, 185, 84, 0.2);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #1DB954;
            margin-top: 8px;
            font-weight: 600;
        }
        
        .reset-btn {
            background: transparent;
            border: none;
            color: #636366;
            margin-top: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
        }
        
        .reset-btn:hover { 
            color: white; 
        }

        .download-progress {
            width: 100%;
            margin-top: 15px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1DB954, #1ed760);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.85rem;
            color: #8e8e93;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>

    <div class="card">
        <svg class="spotify-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.4-1.02 15.06 1.141.6.3.839 1.08.539 1.68-.24.6-.839.84-1.439.54z"/>
        </svg>

        <h1>Spotify <span>Downloader</span></h1>
        <p class="subtitle" id="main-subtitle">High-quality MP3 streaming & download</p>

        <div id="search-area">
            <div class="input-group">
                <i class="fa-solid fa-link"></i>
                <input type="text" id="url" placeholder="Paste Spotify track link...">
            </div>

            <button class="btn-dl" onclick="fetchMetadata()" id="btn-search">
                <i class="fa-solid fa-bolt-lightning"></i>
                <span>Download Music</span>
            </button>
        </div>

        <div id="result-area">
            <img src="" alt="Album Art" id="res-cover" class="album-cover">
            <div class="track-info">
                <div id="res-title" class="track-title">Title</div>
                <div id="res-artist" class="track-artist">Artist</div>
                <div>
                    <span id="res-duration" class="meta-badge">00:00</span>
                    <span id="res-filesize" class="file-size-badge" style="display: none;">
                        <i class="fa-solid fa-file-audio"></i> Calculating...
                    </span>
                </div>
            </div>
            
            <button class="btn-dl" onclick="downloadFile()" id="btn-download">
                <i class="fa-solid fa-download"></i>
                <span>Download MP3</span>
            </button>

            <div class="download-progress" id="download-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Downloading... 0%</div>
            </div>
            
            <button class="reset-btn" onclick="resetSearch()">Download another</button>
        </div>

        <div id="loader" class="status">
            <i class="fa-solid fa-circle-notch spin"></i>
            <span id="loader-text">Fetching Metadata...</span>
        </div>
    </div>

    <script>
        // Global variables
        let currentDownloadUrl = ''; // ← URL download dari API
        let currentTitle = '';
        let currentFileSize = null;

        /**
         * Convert bytes to human-readable format
         */
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 Bytes';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        /**
         * Fetch file size before showing download button
         */
        async function getFileSize(downloadUrl, title) {
            try {
                const url = `/api/download?url=${encodeURIComponent(downloadUrl)}&title=${encodeURIComponent(title)}`;
                
                // HEAD request untuk dapetin Content-Length tanpa download file
                const response = await fetch(url, { method: 'HEAD' });
                
                const contentLength = response.headers.get('content-length');
                if (contentLength) {
                    return parseInt(contentLength);
                }
                return null;
            } catch (error) {
                console.error('Failed to get file size:', error);
                return null;
            }
        }

        /**
         * Fetch metadata lagu dari Spotify
         */
        async function fetchMetadata() {
            const input = document.getElementById('url');
            const loader = document.getElementById('loader');
            const searchArea = document.getElementById('search-area');
            const resultArea = document.getElementById('result-area');
            const subtitle = document.getElementById('main-subtitle');
            const loaderText = document.getElementById('loader-text');
            const fileSizeBadge = document.getElementById('res-filesize');

            // Validasi input
            if (!input.value || !input.value.includes('spotify')) {
                input.parentElement.classList.add('shake');
                input.style.borderColor = '#ef4444';
                setTimeout(() => {
                    input.parentElement.classList.remove('shake');
                    input.style.borderColor = 'rgba(255, 255, 255, 0.08)';
                }, 400);
                return;
            }

            // Show loader
            searchArea.style.display = 'none';
            subtitle.style.display = 'none';
            loader.style.display = 'flex';
            loaderText.innerText = "Searching Track...";

            try {
                // Fetch track info
                const res = await fetch(`/api/info?url=${encodeURIComponent(input.value)}`);
                const json = await res.json();

                if (!res.ok) {
                    throw new Error(json.error || 'Failed to fetch track info');
                }

                const data = json.data || json;

                // Populate UI
                document.getElementById('res-cover').src = data.cover || '';
                document.getElementById('res-title').innerText = data.title || "Unknown Title";
                document.getElementById('res-artist').innerText = data.artist || "Unknown Artist";
                document.getElementById('res-duration').innerText = data.duration || "00:00";
                
                // ✅ PERUBAHAN UTAMA: Simpan downloadUrl dari response
                currentDownloadUrl = data.downloadUrl || '';
                currentTitle = data.title || 'spotify-music';

                if (!currentDownloadUrl) {
                    throw new Error('Download URL not found in response');
                }

                // Show result area first
                loader.style.display = 'none';
                resultArea.style.display = 'flex';

                // Fetch file size in background
                loaderText.innerText = "Calculating file size...";
                loader.style.display = 'flex';
                fileSizeBadge.style.display = 'inline-block';
                
                currentFileSize = await getFileSize(currentDownloadUrl, currentTitle);
                
                loader.style.display = 'none';
                
                if (currentFileSize) {
                    fileSizeBadge.innerHTML = `<i class="fa-solid fa-file-audio"></i> ${formatFileSize(currentFileSize)}`;
                } else {
                    fileSizeBadge.style.display = 'none';
                }

            } catch (error) {
                console.error('Fetch error:', error);
                alert('Error: ' + error.message);
                resetSearch();
            }
        }

        /**
         * Download file with progress tracking
         */
        async function downloadFile() {
            const btn = document.getElementById('btn-download');
            const progressContainer = document.getElementById('download-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            btn.style.display = 'none';
            progressContainer.style.display = 'block';

            try {
                // ✅ PERUBAHAN UTAMA: Gunakan currentDownloadUrl
                const downloadUrl = `/api/download?url=${encodeURIComponent(currentDownloadUrl)}&title=${encodeURIComponent(currentTitle)}`;
                
                const response = await fetch(downloadUrl);
                
                if (!response.ok) throw new Error('Download failed');

                const contentLength = response.headers.get('content-length');
                const total = parseInt(contentLength) || currentFileSize || 0;
                
                let loaded = 0;
                const reader = response.body.getReader();
                const chunks = [];

                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    chunks.push(value);
                    loaded += value.length;
                    
                    if (total > 0) {
                        const progress = Math.round((loaded / total) * 100);
                        progressFill.style.width = progress + '%';
                        progressText.innerText = `Downloading... ${progress}% (${formatFileSize(loaded)} / ${formatFileSize(total)})`;
                    } else {
                        progressText.innerText = `Downloading... ${formatFileSize(loaded)}`;
                    }
                }

                // Create blob and download
                const blob = new Blob(chunks, { type: 'audio/mpeg' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentTitle}.mp3`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                progressText.innerText = `Download Complete! ${formatFileSize(loaded)}`;
                progressFill.style.width = '100%';

                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    btn.style.display = 'flex';
                    progressFill.style.width = '0%';
                }, 3000);

            } catch (error) {
                console.error('Download error:', error);
                alert('Download failed: ' + error.message);
                progressContainer.style.display = 'none';
                btn.style.display = 'flex';
            }
        }

        /**
         * Reset form to initial state
         */
        function resetSearch() {
            document.getElementById('search-area').style.display = 'block';
            document.getElementById('main-subtitle').style.display = 'block';
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('loader').style.display = 'none';
            document.getElementById('download-progress').style.display = 'none';
            document.getElementById('res-filesize').style.display = 'none';
            document.getElementById('url').value = '';
            currentDownloadUrl = '';
            currentTitle = '';
            currentFileSize = null;
        }

        // Enter key listener
        document.getElementById('url').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                fetchMetadata();
            }
        });
    </script>
</body>
</html>